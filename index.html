<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 歐洲旅遊行程表</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for beautiful SVG icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自訂捲軸隱藏，保持介面乾淨 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: -2rem;
            left: 1.25rem;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        .timeline-item:last-child .timeline-line::before {
            bottom: 0;
        }

        /* Modal 動畫過渡效果 */
        #info-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        #info-modal.show .modal-card {
            transform: scale(1);
        }
    </style>
</head>

<body class="text-gray-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-sm z-20 flex-shrink-0">
        <div
            class="px-4 pt-6 pb-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-b-3xl shadow-lg flex justify-between items-start">
            <div>
                <h1 class="text-xl font-bold tracking-wider">✈️ 2026 歐洲24天大縱走</h1>
                <p class="text-blue-100 text-sm mt-1 opacity-90"><i data-lucide="calendar"
                        class="inline w-3 h-3 mb-0.5"></i> 02/27 - 03/22</p>
            </div>
            <!-- 同步按鈕 (手動從雲端抓取) -->
            <button id="sync-btn" onclick="forceSync()"
                class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-all flex items-center justify-center shadow-sm active:scale-95"
                title="從 Google 試算表同步最新資料">
                <i data-lucide="refresh-cw" class="w-5 h-5 text-white"></i>
            </button>
        </div>

        <!-- Day Tabs (Horizontal Scrollable) -->
        <div class="px-2 py-3 border-b border-gray-100 relative">
            <nav id="day-tabs" class="flex space-x-2 overflow-x-auto no-scrollbar px-2 snap-x scroll-smooth">
                <!-- Tabs will be injected here via JS -->
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative z-10 bg-gray-50 pb-20">
        <div id="content-area" class="px-4 py-6 max-w-lg mx-auto">
            <!-- Loading 狀態顯示 -->
            <div id="loading-indicator" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4 text-blue-500"></i>
                <p class="font-bold tracking-widest text-sm">載入行程中...</p>
            </div>
            <!-- Content injected via JS -->
        </div>
    </main>

    <!-- Modal (隱藏的彈窗) -->
    <div id="info-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"
        onclick="closeModal(event)">
        <div class="modal-card bg-white rounded-2xl w-11/12 max-w-md p-6 transform scale-95 transition-transform duration-300 shadow-2xl relative max-h-[85vh] flex flex-col"
            onclick="event.stopPropagation()">
            <button onclick="closeModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 hover:bg-gray-100 rounded-full p-1.5 transition-colors z-10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- 彈窗頂部區塊 (固定不捲動) -->
            <div class="flex-shrink-0 pr-8 border-b border-gray-100 pb-4 mb-4">
                <h3 id="modal-title" class="text-xl font-black text-gray-800 leading-snug mb-2.5"></h3>
                <div id="modal-transport-container" class="hidden">
                    <span id="modal-transport"
                        class="text-xs font-bold text-blue-700 bg-blue-50 border border-blue-100 px-2.5 py-1 rounded-md inline-flex items-center"></span>
                </div>
            </div>

            <!-- 彈窗內容區塊 (可獨立捲動) -->
            <div id="modal-content" class="flex-1 overflow-y-auto no-scrollbar text-[15px] pr-1 pb-2">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Application Logic & Data -->
    <script>
        const DATA_URL = 'plan.json'; // 行程資料 JSON 檔案路徑
        const CACHE_KEY = 'europe_itinerary_2026_v2_cache'; // LocalStorage 快取金鑰

        let itineraryData = [];
        let currentActiveDayId = 0;

        // 初始化 Lucide icon
        lucide.createIcons();

        // --- 應用程式初始化邏輯 (離線優先 + 背景更新) ---
        function loadApp() {
            const cachedData = localStorage.getItem(CACHE_KEY);

            if (cachedData) {
                try {
                    itineraryData = JSON.parse(cachedData);
                    document.getElementById('loading-indicator').style.display = 'none';
                    initApp();
                } catch (e) { }
            }
            // 無論是否有快取，都在背景靜默抓取最新資料
            fetchData(false);
        }

        // --- 手動強制同步 (點擊右上角按鈕觸發) ---
        function forceSync() {
            const syncIcon = document.querySelector('#sync-btn i');
            syncIcon.classList.add('animate-spin');
            fetchData(true);
        }

        // --- 從 plan.json 讀取行程資料 ---
        async function fetchData(isManual = false) {
            try {
                const url = `${DATA_URL}?t=${new Date().getTime()}`;
                const response = await fetch(url);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const parsedData = await response.json();

                if (parsedData.length > 0) {
                    itineraryData = parsedData;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(itineraryData));
                    document.getElementById('loading-indicator').style.display = 'none';
                    initApp();
                    if (isManual) showToast('✅ 行程資料同步成功！');
                } else {
                    if (isManual) showToast('⚠️ 抓取成功但資料為空', true);
                }
            } catch (err) {
                console.error('載入行程資料失敗:', err);
                if (isManual) {
                    showToast('❌ 同步失敗：無法載入行程資料', true);
                } else if (itineraryData.length === 0) {
                    showError("載入失敗", "無法載入行程資料，請確認網路狀態後重試。");
                }
            } finally {
                stopSyncIcon();
            }
        }

        function stopSyncIcon() {
            const syncIcon = document.querySelector('#sync-btn i');
            if (syncIcon) syncIcon.classList.remove('animate-spin');
        }

        // --- 輕量級提示框 (Toast UI) ---
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-5 py-2.5 rounded-full text-[14px] font-bold shadow-xl z-50 transition-all duration-300 opacity-0 flex items-center gap-2 ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.innerText = message;
            document.body.appendChild(toast);

            // 觸發淡入動畫
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100', '-translate-y-2');
            });

            // 2.5 秒後淡出並移除
            setTimeout(() => {
                toast.classList.remove('opacity-100', '-translate-y-2');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function showError(title, msg) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="text-center text-red-500 py-10">
                    <i data-lucide="wifi-off" class="w-12 h-12 mx-auto mb-4 text-red-400"></i>
                    <p class="font-bold text-xl mb-2">${title}</p>
                    <p class="text-[15px] text-gray-500 max-w-xs mx-auto">${msg}</p>
                </div>
            `;
            lucide.createIcons();
        }

        // --- 輔助函式 ---
        function getTransportIcon(type) {
            if (!type) return 'clock';
            if (type.includes('飛機')) return 'plane';
            if (type.includes('自駕') || type.includes('叫車')) return 'car';
            if (type.includes('巴士') || type.includes('公車')) return 'bus';
            if (type.includes('火車') || type.includes('電車') || type.includes('歐洲之星') || type.includes('國鐵') || type.includes('地鐵')) return 'train-front';
            if (type.includes('渡輪') || type.includes('遊船')) return 'ship';
            if (type.includes('步行')) return 'footprints';
            if (type.includes('纜車')) return 'tram-front';
            return 'clock';
        }

        // --- 彈窗處理 (Modal) ---
        function openModal(dayId, eventIndex) {
            const dayInfo = itineraryData.find(d => d.id === dayId);
            const event = dayInfo.events[eventIndex];

            document.getElementById('modal-title').innerText = event.ti;

            const transStr = event.tr;
            const transportContainer = document.getElementById('modal-transport-container');
            const transportEl = document.getElementById('modal-transport');

            if (transStr && transStr !== '-') {
                transportEl.innerHTML = `<i data-lucide="${getTransportIcon(transStr)}" class="w-3.5 h-3.5 mr-1.5"></i>交通：${transStr}`;
                transportContainer.classList.remove('hidden');
            } else {
                transportContainer.classList.add('hidden');
            }

            let contentHtml = '';

            if (event.n) {
                contentHtml += `
                    <div class="mb-5 bg-gray-50 p-3.5 rounded-xl border border-gray-200/60 shadow-sm">
                        <p class="text-gray-700 text-[14px] font-medium leading-relaxed whitespace-pre-line flex items-start">
                            <i data-lucide="info" class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0 mt-0.5"></i>
                            <span>${event.n}</span>
                        </p>
                    </div>
                `;
            }

            if (event.intro) {
                contentHtml += `
                    <div class="mb-5">
                        <h4 class="flex items-center text-[15px] font-black text-emerald-700 mb-2">
                            <i data-lucide="leaf" class="w-4 h-4 mr-1.5"></i> 景點簡介
                        </h4>
                        <div class="bg-gradient-to-br from-emerald-50/80 to-emerald-50/30 p-4 rounded-2xl border border-emerald-100/70">
                            <p class="text-gray-700 text-[14px] leading-relaxed whitespace-pre-line">${event.intro}</p>
                        </div>
                    </div>
                `;
            }

            if (event.story) {
                contentHtml += `
                    <div class="mb-2">
                        <h4 class="flex items-center text-[15px] font-black text-amber-700 mb-2">
                            <i data-lucide="book-open" class="w-4 h-4 mr-1.5"></i> 歷史與故事
                        </h4>
                        <div class="bg-gradient-to-br from-amber-50/80 to-amber-50/30 p-4 rounded-2xl border border-amber-100/70">
                            <p class="text-gray-700 text-[14px] leading-relaxed whitespace-pre-line">${event.story}</p>
                        </div>
                    </div>
                `;
            }

            document.getElementById('modal-content').innerHTML = contentHtml;
            lucide.createIcons();

            const modal = document.getElementById('info-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        function closeModal(event) {
            const modal = document.getElementById('info-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                // Wait for transition
            }, 300);
        }

        // --- 智慧日期選擇邏輯 ---
        function detectCurrentDay() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;

            const match = itineraryData.find(day => day.dateStr === todayStr);
            if (match) {
                currentActiveDayId = match.id;
            } else {
                currentActiveDayId = 0; // 預設第一天
            }
        }

        // --- 渲染函式 ---
        function initApp() {
            detectCurrentDay();
            renderTabs();
            renderContent(currentActiveDayId);
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            tabsContainer.innerHTML = '';

            itineraryData.forEach(dayInfo => {
                const btn = document.createElement('button');
                const isActive = dayInfo.id === currentActiveDayId;

                btn.className = `flex-shrink-0 px-4 py-2 rounded-full text-[15px] font-bold transition-all duration-300 snap-center outline-none ${isActive
                    ? 'bg-blue-600 text-white shadow-md transform scale-105'
                    : 'bg-white text-gray-500 border border-gray-200 hover:bg-gray-100'
                    }`;
                btn.innerText = dayInfo.day;
                btn.onclick = () => {
                    currentActiveDayId = dayInfo.id;
                    renderTabs();
                    renderContent(dayInfo.id);
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                };
                tabsContainer.appendChild(btn);
            });

            setTimeout(() => {
                const activeBtn = tabsContainer.children[currentActiveDayId];
                if (activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }, 100);
        }

        function renderContent(dayId) {
            const contentArea = document.getElementById('content-area');
            const dayData = itineraryData.find(d => d.id === dayId);

            if (!dayData) return;

            let html = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-800">${dayData.day}</h2>
                        <p class="text-[15px] font-bold text-blue-600 mt-1 tracking-wide">${dayData.date} · ${dayData.location}</p>
                    </div>
                </div>
                <div class="relative timeline-line">
            `;

            dayData.events.forEach((event, index) => {
                const iconName = getTransportIcon(event.tr);
                const isLast = index === dayData.events.length - 1;
                const mapLink = event.navigation || '';
                const showMapBtn = !!mapLink;
                const hasInfo = event.n || event.intro || event.story;

                const infoBtnHtml = hasInfo ? `
                    <button onclick="openModal(${dayData.id}, ${index})" class="flex items-center gap-1 bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-gray-200 transition-colors shadow-sm active:scale-95 ml-2">
                        <i data-lucide="info" class="w-3.5 h-3.5"></i> 詳情
                    </button>
                ` : '';

                html += `
                <div class="timeline-item relative pl-10 mb-5 ${isLast ? '' : ''}">
                    <div class="absolute left-[-1px] top-1.5 w-8 h-8 rounded-full bg-white border-2 border-blue-500 flex items-center justify-center shadow-sm z-10">
                        <i data-lucide="${iconName}" class="w-4 h-4 text-blue-600"></i>
                    </div>

                    <div class="bg-white p-4 py-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-2">
                            <span class="inline-block px-2.5 py-1 bg-gray-100 text-gray-700 rounded-md text-[13px] font-bold tracking-wide">${event.t}</span>
                            
                            <div class="flex items-center">
                                ${showMapBtn ? `
                                <a href="${mapLink}" target="_blank" class="flex items-center gap-1 bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-100 transition-colors shadow-sm active:scale-95">
                                    <i data-lucide="map-pin" class="w-3.5 h-3.5"></i> 導航
                                </a>
                                ` : ''}
                                ${infoBtnHtml}
                            </div>
                        </div>
                        
                        <h3 class="text-[17px] font-bold text-gray-800 leading-snug mt-3 mb-2">${event.ti}</h3>
                        
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${event.c ? `<span class="flex items-center gap-1 text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-md border border-emerald-100"><i data-lucide="circle-dollar-sign" class="w-3 h-3"></i> ${event.c}</span>` : ''}
                            ${event.o ? `<span class="flex items-center gap-1 text-xs font-bold text-orange-700 bg-orange-50 px-2 py-1 rounded-md border border-orange-100"><i data-lucide="clock" class="w-3 h-3"></i> ${event.o}</span>` : ''}
                        </div>
                    </div>
                </div>
                `;
            });

            html += `</div>`;

            contentArea.innerHTML = html;

            lucide.createIcons();
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 註冊 Service Worker (離線快取) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        // --- 當頁面載入完成後啟動 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApp();
        });
    </script>
</body>

</html>